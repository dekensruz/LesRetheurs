
-- SQL Script for Les Rhéteurs (Full Schema & Security)

-- 1. Table des Profiles
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE NOT NULL PRIMARY KEY,
  updated_at TIMESTAMPTZ DEFAULT now(),
  username TEXT UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  bio TEXT
);

-- 2. Table des publications
CREATE TABLE IF NOT EXISTS public.posts (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT now(),
    title TEXT NOT NULL,
    book_title TEXT NOT NULL,
    book_author TEXT,
    content TEXT NOT NULL,
    user_name TEXT NOT NULL,
    category TEXT NOT NULL,
    cover_url TEXT,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE
);

-- 3. Table des Répliques
CREATE TABLE IF NOT EXISTS public.replies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT now(),
    post_id UUID REFERENCES public.posts(id) ON DELETE CASCADE NOT NULL,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    user_name TEXT NOT NULL,
    content TEXT NOT NULL,
    quoted_text TEXT,
    parent_reply_id UUID REFERENCES public.replies(id) ON DELETE SET NULL
);

-- 4. Table des Cercles de Lecture
CREATE TABLE IF NOT EXISTS public.circles (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT now(),
    name TEXT NOT NULL,
    description TEXT,
    theme TEXT NOT NULL,
    is_private BOOLEAN DEFAULT false,
    cover_url TEXT,
    creator_id UUID REFERENCES auth.users(id) ON DELETE CASCADE
);

-- 5. Table des Membres des Cercles
CREATE TABLE IF NOT EXISTS public.circle_members (
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    role TEXT DEFAULT 'member',
    PRIMARY KEY (circle_id, user_id)
);

-- 6. Table des Lectures Communes
CREATE TABLE IF NOT EXISTS public.circle_readings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE NOT NULL,
    book_title TEXT NOT NULL,
    book_author TEXT,
    start_date DATE DEFAULT CURRENT_DATE,
    end_date DATE,
    synthesis TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 7. Tables des votes, citations, progression
CREATE TABLE IF NOT EXISTS public.circle_polls (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE,
    options JSONB NOT NULL,
    is_closed BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.circle_poll_votes (
    poll_id UUID REFERENCES public.circle_polls(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    option_index INTEGER NOT NULL,
    PRIMARY KEY (poll_id, user_id)
);

CREATE TABLE IF NOT EXISTS public.circle_quotes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    page_number TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.circle_threads (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.circle_thread_messages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    thread_id UUID REFERENCES public.circle_threads(id) ON DELETE CASCADE NOT NULL,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.circle_reading_roles (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    role_name TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(circle_id, role_name)
);

CREATE TABLE IF NOT EXISTS public.circle_member_progress (
    circle_id UUID REFERENCES public.circles(id) ON DELETE CASCADE,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    percentage INTEGER DEFAULT 0 CHECK (percentage >= 0 AND percentage <= 100),
    PRIMARY KEY (circle_id, user_id)
);

-- ACTIVATION RLS
ALTER TABLE public.circle_poll_votes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.circle_thread_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.circle_readings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public Read Votes" ON public.circle_poll_votes FOR SELECT USING (true);
CREATE POLICY "Auth Vote" ON public.circle_poll_votes FOR ALL USING (auth.uid() = user_id);
CREATE POLICY "Public Read Thread Messages" ON public.circle_thread_messages FOR SELECT USING (true);
CREATE POLICY "Auth Post Thread Message" ON public.circle_thread_messages FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Creators manage readings" ON public.circle_readings FOR ALL USING (EXISTS (SELECT 1 FROM public.circles WHERE id = circle_readings.circle_id AND creator_id = auth.uid()));
